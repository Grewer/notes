node_modules ç˜¦èº«-ä¿®æ”¹ç‰ˆ

## èµ·å› 

**åœºæ™¯ä¸€:**  
å½“å‰é¡¹ç›®ç»å†äº†åˆ€è€•ç«ç§åœ°å¼€å‘, ä¹‹åæ¥å…¥äº† cli å·¥å…·é›†ä¸­ç®¡ç†æ‰“åŒ…, é‚£ä¹ˆé¡¹ç›®ä¸­çš„ä¾èµ–,
å’Œ cli å·¥å…·ä¸­çš„ä¾èµ–é‡åˆåº¦æ˜¯å¤šå°‘, å¹¶ä¸”ä»–çš„çš„ç‰ˆæœ¬æ˜¯å¦ç›¸åŒ, æ˜¯å¦æœ‰å†—ä½™ä»£ç 

**åœºæ™¯äºŒ:**  
é¡¹ç›®ä¸­æŸä¸€ä¸ªåº“å‡çº§äº†, ä»–ä¾èµ–äº† A åº“çš„ V3 ç‰ˆæœ¬, åŒæ—¶å½“å‰é¡¹ç›®ä¾èµ–çš„æ˜¯ A åº“ V2ç‰ˆæœ¬, è¿™ä¸ªæ—¶å€™æ‰“åŒ…å¾ˆæ˜æ˜¾, å°±ä¼šå°†è¿™ä¸€ä¸ªåŒ…çš„ä¸åŒç‰ˆæœ¬åŒæ—¶æ‰“å…¥

**åœºæ™¯ä¸‰:**  
å½“å‰ deps ä¸­æœ‰å¯¹åº”çš„ä¾èµ–åº“, ä½†æ˜¯ä¸šåŠ¡ä»£ç ä¸­å¹¶æœªä½¿ç”¨åˆ°

ç”±äºä¸Šè¿°çš„åœºæ™¯, æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå·¥å…·æ¥è§£å†³è¿™äº›æƒ…å†µ


## æ€è€ƒğŸ¤”

> è¿™äº›åœºæ™¯æ”¹å¦‚ä½•è§£å†³, è§£å†³çš„æ–¹æ¡ˆæ˜¯ä»€ä¹ˆ

é’ˆå¯¹åœºæ™¯ä¸‰æ¥è¯´, ç°åœ¨å·²ç»æœ‰ä¸€ä¸ªåº“: [depcheck](https://www.npmjs.com/package/depcheck)

ç®€å•çš„åŸç†: é€šè¿‡æ£€æµ‹é¡¹ç›®ä¸­çš„æ–‡ä»¶ `import` æˆ–è€… `require` å’Œä¾èµ–è¿›è¡Œå¯¹æ¯”, æœ€åç”Ÿæˆä¾èµ–åˆ—è¡¨

æƒ³è¦ä¸€å®šçš„é…ç½®
(é€šè¿‡å®é™…çš„è°ƒç”¨, å‘ç°è¿˜å­˜åœ¨ä¸€å®šçš„é—®é¢˜: åœ¨å­æ¨¡å—ä¸­çš„ä»£ç æœªèƒ½è¢«æ£€æµ‹, åŒæ—¶å…³äºä¾èµ–ä¸­çš„ babel é…ç½®æ’ä»¶æ£€æµ‹ä¹Ÿæ˜¯åŒæ ·çš„)

è€Œåœºæ™¯ä¸€å’ŒäºŒå°±å’Œä¸‰ä¸å¤ªä¸€æ ·äº†, ä»–æ˜¯å·²æœ‰åº“, ä½†æ˜¯ç•¥æœ‰é‡å¤, æ‰€æœ‰éœ€è¦é’ˆå¯¹åº“è¿›è¡Œæ£€æµ‹

ç›®å‰è®¡åˆ’æ˜¯é€šè¿‡ node è„šæœ¬æ¥è¿è¡Œ

- æ£€æŸ¥ node_modules æˆ–è€… lock æ–‡ä»¶ä¸­, æ˜¯å¦å­˜åœ¨åŒä¸€åº“çš„å¤šä¸ªç‰ˆæœ¬

- node_modules æ–‡ä»¶å±‚çº§å¤ªå¤š, lock æ–‡ä»¶æ˜¯ä»–çš„ä¸€å±‚æ˜ å°„, è€ƒè™‘ä»è¿™é‡Œå…¥æ‰‹

- ç¡®ä¿ lock æ–‡ä»¶æ˜¯æœ€æ–°çš„(è¿™ä¸€å±‚æ¯”è¾ƒéº»çƒ¦, æ²¡æ ‡è¯†æ¥ä¿è¯, æ˜ç¡®å°±ç¡®ä¿æ­¤æ–‡ä»¶æ˜¯å¦å­˜åœ¨å³å¯)

- æ‰“å¼€æœ¬åœ°ç½‘ç«™, é’ˆå¯¹ç»“æœçš„å¯è§†åŒ–æ˜¾ç¤º(ç»è¿‡å®é™…çš„æ“ä½œ, è¿™ä¸€åœºæ™¯æ”¾å¼ƒ, å…·ä½“åŸå› æ”¾ä¸‹ä¸‹æ–¹è¯¦è¿°)



## å¼€å‘

è¿™é‡Œæˆ‘ä»¬é¦–å…ˆè§£å†³åœºæ™¯ä¸€çš„é—®é¢˜

### åœºæ™¯ä¸€
åœ¨ä¸Šé¢çš„æ€è€ƒä¸­é’ˆå¯¹æ­¤åœºæ™¯å·²ç»äº†ä¸€è§£å†³æ–¹æ¡ˆäº†, å³ `depcheck` åœºæ™¯, ä½†æ˜¯ä»–çš„é…ç½®éœ€è¦é‡æ–°ç¼–å†™:
  

#### check é…ç½®æ›´æ–°

```js
const options = {
    ignoreBinPackage: false, // ignore the packages with bin entry
    skipMissing: false, // skip calculation of missing dependencies
    ignorePatterns: [
        // files matching these patterns will be ignored
        'sandbox',
        'dist',
        'bower_components',
        'tsconfig.json'
    ],
    ignoreMatches: [
        // ignore dependencies that matches these globs
        'grunt-*',
    ],
    parsers: {
        // the target parsers
        '**/*.js': depcheck.parser.es6,
        '**/*.jsx': depcheck.parser.jsx,
        '**/*.ts': depcheck.parser.typescript,
        // è¿™é‡Œ ts ç±»å‹å¯èƒ½ä¼šå‡ºé—®é¢˜, ä½†æ˜¯ç»è¿‡å®é™…çš„è¿è¡Œå’Œæ–‡æ¡£è¯´æ˜æ˜¯æ²¡é—®é¢˜çš„
        '**/*.tsx': [depcheck.parser.typescript, depcheck.parser.jsx],
    },
    detectors: [
        // the target detectors
        depcheck.detector.requireCallExpression,
        depcheck.detector.requireResolveCallExpression,
        depcheck.detector.importDeclaration,
        depcheck.detector.exportDeclaration,
        depcheck.detector.gruntLoadTaskCallExpression,
        depcheck.detector.importCallExpression,
        depcheck.detector.typescriptImportEqualsDeclaration,
        depcheck.detector.typescriptImportType,
    ],
    // specials: [
    //     // Depcheck APIåœ¨é€‰é¡¹ä¸­æš´éœ²äº†ç‰¹æ®Šå±æ€§ï¼Œå®ƒæ¥å—ä¸€ä¸ªæ•°ç»„ï¼Œä»¥æŒ‡å®šç‰¹æ®Šåˆ†æå™¨ã€‚
    // ],
    // è¿™é‡Œå°†ä¼šè¦†ç›–åŸæœ¬çš„ package.json çš„è§£æ
    // package: {
    // },
};
```

ä¹‹åå†è°ƒç”¨é…ç½®:

```js
// é»˜è®¤å³å½“å‰è·¯å¾„
const check = (path = process.cwd()) => depcheck(path ,options)
```

æœ€ååŠ ä¸Šæ‰“å°ç»“æœ:

```js
console.log('Unused dependencies:')
unused.dependencies.forEach(name=>{
    console.log(chalk.greenBright(`* ${name}`))
})
console.log('Unused devDependencies:'); 
unused.devDependencies.forEach(name=>{
    console.log(chalk.greenBright(`* ${name}`))
})
```

è°ƒç”¨ç»“æœçš„ä¾‹å­å±•ç¤º:
![](images/check-shot.png)

### åœºæ™¯äºŒ

#### æŒ‡ä»¤æŠ€æœ¯é€‰å‹:

1. commander

æ¨èæœ€å¤šçš„, åŒæ—¶ä¹Ÿæ˜¯ä¸‹è½½é‡æœ€å¤šçš„, ä¸‹è½½é‡ 8kw+

2. package-lock.json

é’ˆå¯¹çš„ lock æ–‡ä»¶, é»˜è®¤ `npm` åŠå…¶å¯¹åº”çš„è§£æ, ç°åœ¨è¿˜æœ‰ `yarn`, `pnpm` æ¯”è¾ƒæµè¡Œ, ä½†æ˜¯
ä¸€èˆ¬åœ¨æœåŠ¡å™¨ä¸Šæ‰“åŒ…æ—¶éƒ½ç”¨ä½¿ç”¨ `npm` æŒ‡ä»¤

### æŒ‡ä»¤çš„å¼€å‘

è®¡åˆ’ä¸­çš„æŒ‡ä»¤

- check // é»˜è®¤åœºæ™¯ä¸€çš„æ“ä½œ
- check json // è§£æ .lock æ–‡ä»¶, åŒæ—¶æ‰“å°å ç”¨ç©ºé—´çš„åŒ…
- check json -d  // å°†ç»“æœæ‰“å°æˆæ–‡ä»¶

#### ç¬¬ä¸€æ­¥

æŒ‡ä»¤çš„å®šä¹‰:

```js
const main = () => {
    const program = new commander.Command();
    program.command('check')
        .description('æ£€æŸ¥ä½¿ç”¨åº“')
        .action((options) => {
            // æ˜¾ç¤ºä¸€ä¸ª loading
            const spinner = ora('Loading check').start();
            
            // check
            check()
            
        }).command('json').description('è§£æ lockæ–‡ä»¶').option('-d, --doc', 'è§£æ lock æ–‡ä»¶, å°†ç»“æœä¿å­˜')
        .action(async (options) => {
            // æ˜¾ç¤º loading
            const spinner = ora('Loading check').start();
            // æ‰§è¡Œè„šæœ¬
            // é¢å¤–åˆ¤æ–­ options.open
            deepCheck(spinner, options)
        })
    
    program.parse();
}
```

#### ç¬¬äºŒæ­¥ è§£ææ–‡ä»¶

é¦–å…ˆæˆ‘ä»¬é€šè¿‡ fs æ¥è·å–æ–‡ä»¶å†…å®¹:

```js
const lockPath = path.resolve('package-lock.json')

const data = fs.readFileSync(lockPath, 'utf8')
```

é’ˆå¯¹ lock æ•°æ®è§£æ:

```js
    const allPacks = new Map();
    
    Object.keys(allDeps).forEach(name => {
        const item = allDeps[name]
        if (item.dev) {
            // dev çš„æš‚æ—¶å¿½ç•¥æ‰
            return
        }
        
        if (item.requires) {
            // å’Œitem.dependenciesä¸­çš„æ“ä½œç±»ä¼¼
            setCommonPack(item.requires, name, item.dependencies)
        }
        
        if (item.dependencies) {
            Object.keys(item.dependencies).forEach(depsName => {
                const depsItem = item.dependencies[depsName]
                if (!allPacks.has(depsName)) {
                    allPacks.set(depsName, [])
                }
                const packArr = allPacks.get(depsName);
                
                packArr.push({
                    location: `${name}/node_modules/${depsName}`,
                    version: depsItem.version,
                    label: 'reDeps', // æ ‡è¯†ä¸ºé‡å¤çš„ä¾èµ–
                    size: getFileSize(`./node_modules/${name}/node_modules/${depsName}`)
                })
                allPacks.set(depsName, packArr)
            })
        }
    })
```

æœ€åé€šè¿‡ä¸€ä¸ªå¾ªç¯æ¥è®¡ç®—å‡ºæš‚ç”¨ç©ºé—´æœ€å¤§çš„åŒ…:

```js
    // åˆ›å»ºä¸€ä¸ªæ’åºæ•°æ®, push ä¹‹åè‡ªåŠ¨æ ¹æ® size æ’åº
    let topSizeIns = createTopSize()
    
    allPacks.forEach((arr, name, index) => {
        if(arr.length <= 1){
            return
        }
        let localSize = 0
        arr.forEach((item, itemIndex) => {
            const size = Number(item.size)
            localSize += size
        })
        
        topSizeIns.push({items: arr, size: localSize})
    })

    // æœ€åæ‰“å°ç»“æœ, è¾“å‡ºå¯é€‰æ‹©æ–‡æ¡£
    if (options.doc) {
        fs.writeFileSync(`deepCheck.json`, `${JSON.stringify(mapChangeObj(allPacks), null, 2)}`, {encoding: 'utf-8'})
    }
    
    // æ‰“å° top5
    console.log(chalk.yellow('å ç”¨ç©ºé—´æœ€å¤§çš„ 5 ä¸ªé‡å¤åº“:'))
    topSizeIns.arr.forEach(itemObj => {
        const common = itemObj.items.find(it => it.label === 'common')
        console.log(chalk.cyan(`${common.location}--${itemObj.size.toFixed(2)}KB`));
        itemObj.items.forEach(it => {
            console.log(`* ${it.location}@${it.version}--size:${it.size}KB`)
        })
    })
```

#### ç¬¬ä¸‰æ­¥

å›¾å½¢åŒ–æ–¹æ¡ˆ(**å·²ç»å¼ƒç”¨**)

å…ˆè¯´è¯´å®ç°æ–¹æ¡ˆ:

1. è½¬æ¢json ç”Ÿæˆçš„æ•°æ®è‡³å›¾è¡¨éœ€è¦çš„æ•°æ®
2. å¯åŠ¨æœ¬åœ°æœåŠ¡, å¼•ç”¨ echart å’Œæ•°æ®

æ•°æ®è½¬æ¢:
```js
let nodes = []
let edges = []
packs.forEach((arr, name, index) => {
    let localSize = 0
    arr.forEach((item, itemIndex) => {
        const size = Number(item.size)
        nodes.push({
            x: Math.random() * 1000,
            y: Math.random() * 1000,
            id: item.location,
            name: item.location,
            symbolSize: size > max ? max : size,
            itemStyle: {
                color: getRandomColor(),
            },
        })
        localSize += size
    })
    
    topSizeIns.push({items: arr, size: localSize})
    
    const common = arr.find(it => it.label === 'common')
    if (common) {
        arr.forEach(item => {
            if (item.label === 'common') {
                return
            }
            edges.push({
                attributes: {},
                size: 1,
                source: common.location,
                target: item.location,
            })
        })
    }
})
```

å¯åŠ¨æœåŠ¡:

æœåŠ¡å¹¶æ²¡æœ‰ä½¿ç”¨ä¸‰æ–¹åº“, è€Œæ˜¯æ·»åŠ äº†ä¸€ä¸ªnode http æœåŠ¡:

```js

var mineTypeMap = {
    html: 'text/html;charset=utf-8',
    htm: 'text/html;charset=utf-8',
    xml: "text/xml;charset=utf-8",
    // çœç•¥å…¶ä»–
}

const createServer = () => {
    const chartData = fs.readFileSync(getFile('deepCheck.json'), 'utf8')

    http.createServer(function (request, response) {
        // è§£æè¯·æ±‚ï¼ŒåŒ…æ‹¬æ–‡ä»¶å
        // request.url
        if (request.url === '/') {
            // ä»æ–‡ä»¶ç³»ç»Ÿä¸­è¯»å–è¯·æ±‚çš„æ–‡ä»¶å†…å®¹
            const data = fs.readFileSync(getFile('tools.html'))
            response.writeHead(200, {'Content-Type': 'text/html'});
            // è¿™é‡Œæ˜¯ä½¿ç”¨çš„ç±»ä¼¼æœåŠ¡ç«¯æ•°æ®çš„æ–¹æ¡ˆ, å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨å¼•å…¥ json çš„æ–¹æ¡ˆæ¥è§£å†³
            const _data = data.toString().replace(new RegExp('<%chartData%>'), chartData)
            // å“åº”æ–‡ä»¶å†…å®¹
            response.write(_data);
            response.end();
        } else {
            const targetPath = decodeURIComponent(getFile(request.url)); //ç›®æ ‡åœ°å€æ˜¯åŸºå‡†è·¯å¾„å’Œæ–‡ä»¶ç›¸å¯¹è·¯å¾„çš„æ‹¼æ¥,decodeURIComponent()æ˜¯å°†è·¯å¾„ä¸­çš„æ±‰å­—è¿›è¡Œè§£ç 
            console.log(request.method, request.url, baseDir, targetPath)

            const extName = path.extname(targetPath).substr(1);
            if (fs.existsSync(targetPath)) { //åˆ¤æ–­æœ¬åœ°æ–‡ä»¶æ˜¯å¦å­˜åœ¨
                if (mineTypeMap[extName]) {
                    response.setHeader('Content-Type', mineTypeMap[extName]);
                }
                var stream = fs.createReadStream(targetPath);
                stream.pipe(response);
            } else {
                response.writeHead(404, {'Content-Type': 'text/html'});
                response.end();
            }
        }
    }).listen(8080);

    console.log('Server running at http://127.0.0.1:8080/');

    opener(`http://127.0.0.1:8080/`);
}

export default createServer
```

æ•ˆæœå›¾:

![](./images/img.png)

é€šè¿‡æ­¤å›¾, å¯ä»¥çœ‹åˆ°å¤§æ¦‚é—®é¢˜ç‚¹æ‰€åœ¨:

1. ä¾èµ–åŒ…å¤ªå¤š, å¯¼è‡´æ•°æ®æ˜¾ç¤ºæ‚ä¹± 
2. æ ¹æ®åŒ…çœŸå®å°ºå¯¸å¤§å°æ˜¾ç¤ºåœ†åœˆ, å…¶ä¸­çš„å·®è·è¿‡å¤§, å¤§çš„æœ‰å‡ ä¸‡ kb, å°çš„æœ‰å‡ åkb
   å›¾ä¸­æš‚æ—¶é—²ç½®äº†æœ€å¤§ size 200

æ‰€ä»¥æš‚æ—¶ä¸å¼€å¯æ­¤åŠŸèƒ½

## æ€»ç»“

å½“å‰å·²æ„å»ºå‡ºåŒ…: `@grewer/deps-check` å¯å°è¯•ä½¿ç”¨

é’ˆå¯¹æ–‡ç« ä¸€å¼€å§‹æå‡ºçš„ä¸‰ç§å¸¸è§åœºæ™¯, æ­¤åŒ…åŸºæœ¬ä¸Šèƒ½å¤Ÿè§£å†³äº†

ä¹‹åè¿˜èƒ½æå‡ºä¸€äº›ä¼˜åŒ–ç‚¹, æ¯”å¦‚æœ‰äº›åŒ…çš„æ›¿æ¢(`moment` æ›¿æ¢ `dayjs`, `lodash` å’Œ `lodash.xx` åŒ…ä¸èƒ½åŒæ—¶å­˜åœ¨ç­‰ç­‰)
è¿™äº›å°±éœ€è¦é•¿æœŸç»´æŠ¤ç®¡ç†äº†

