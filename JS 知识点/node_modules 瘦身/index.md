## èµ·å› 
åœºæ™¯ä¸€:  
å½“å‰é¡¹ç›®ç»å†äº†åˆ€è€•ç«ç§åœ°å¼€å‘, ä¹‹åæ¥å…¥äº† cli å·¥å…·é›†ä¸­ç®¡ç†æ‰“åŒ…, é‚£ä¹ˆé¡¹ç›®ä¸­çš„ä¾èµ–,
å’Œ cli å·¥å…·ä¸­çš„ä¾èµ–é‡åˆåº¦æ˜¯å¤šå°‘, å¹¶ä¸”ä»–çš„çš„ç‰ˆæœ¬æ˜¯å¦ç›¸åŒ, æ˜¯å¦æœ‰å†—ä½™ä»£ç 

åœºæ™¯äºŒ:  
é¡¹ç›®ä¸­æŸä¸€ä¸ªåº“å‡çº§äº†, ä»–ä¾èµ–äº† A åº“çš„ V3 ç‰ˆæœ¬, åŒæ—¶å½“å‰é¡¹ç›®ä¾èµ–çš„æ˜¯ A åº“ V2ç‰ˆæœ¬, è¿™ä¸ªæ—¶å€™æ‰“åŒ…å¾ˆæ˜æ˜¾, å°±ä¼šå°†è¿™ä¸€ä¸ªåŒ…çš„ä¸åŒç‰ˆæœ¬åŒæ—¶æ‰“å…¥

åœºæ™¯ä¸‰:
å½“å‰ deps ä¸­æœ‰å¯¹åº”çš„ä¾èµ–åº“, ä½†æ˜¯ä¸šåŠ¡ä»£ç ä¸­å¹¶æœªä½¿ç”¨åˆ°

ç”±äºä¸Šè¿°çš„åœºæ™¯, æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå·¥å…·æ¥è§£å†³è¿™äº›æƒ…å†µ

## æ€è€ƒğŸ¤”

> è¿™äº›åœºæ™¯æ”¹å¦‚ä½•è§£å†³, è§£å†³çš„æ–¹æ¡ˆæ˜¯ä»€ä¹ˆ
>

é’ˆå¯¹åœºæ™¯ä¸‰æ¥è¯´, ç°åœ¨å·²ç»æœ‰ä¸€ä¸ªåº“: [depcheck](https://www.npmjs.com/package/depcheck)

ç®€å•çš„åŸç†: é€šè¿‡æ£€æµ‹é¡¹ç›®ä¸­çš„æ–‡ä»¶ `import` æˆ–è€… `require` å’Œä¾èµ–è¿›è¡Œå¯¹æ¯”, æœ€åç”Ÿæˆä¾èµ–åˆ—è¡¨

ä½†æ˜¯è¿™ä¸ªåº“é€šè¿‡å®é™…çš„è°ƒç”¨, å‘ç°è¿˜å­˜åœ¨ä¸€å®šçš„é—®é¢˜, åœ¨å­æ¨¡å—ä¸­çš„ä»£ç æœªèƒ½è¢«æ£€æµ‹, åŒæ—¶å…³äºä¾èµ–ä¸­çš„ babel é…ç½®æ’ä»¶æ£€æµ‹ä¹Ÿæ˜¯åŒæ ·åœ°,
å…¶ä»–çš„ä¸€äº›node_modules åº“ä¸­çš„å¼ºä¾èµ–, ä¹Ÿæ— æ³•æ£€æµ‹, å¯èƒ½æ˜¯éœ€è¦å¯¹åº”çš„é…ç½®

è€Œåœºæ™¯ä¸€å’ŒäºŒå°±å’Œä¸‰ä¸å¤ªä¸€æ ·äº†, ä»–æ˜¯å·²æœ‰åº“, ä½†æ˜¯ç•¥æœ‰é‡å¤, æ‰€æœ‰éœ€è¦é’ˆå¯¹åº“è¿›è¡Œæ£€æµ‹

ç›®å‰è®¡åˆ’æ˜¯é€šè¿‡ node è„šæœ¬æ¥è¿è¡Œ
- æ£€æŸ¥ node_modules æˆ–è€… lock æ–‡ä»¶ä¸­, æ˜¯å¦å­˜åœ¨åŒä¸€åº“çš„å¤šä¸ªç‰ˆæœ¬

- node_modules æ–‡ä»¶å±‚çº§å¤ªå¤š, lock æ–‡ä»¶æ˜¯ä»–çš„ä¸€å±‚æ˜ å°„, è€ƒè™‘ä»è¿™é‡Œå…¥æ‰‹

- ç¡®ä¿ lock æ–‡ä»¶æ˜¯æœ€æ–°çš„, é‚£ä¹ˆæˆ‘ä»¬éœ€è¦åœ¨è¿è¡Œä¸€é `npm i` æŒ‡ä»¤, é’ˆå¯¹ lock çš„è§£ææ–¹æ¡ˆ

- æ‰“å¼€æœ¬åœ°ç½‘ç«™, é’ˆå¯¹ç»“æœçš„å¯è§†åŒ–æ˜¾ç¤º(æ ‘å½¢å›¾, çˆ¶èŠ‚ç‚¹-é‡å¤çš„åº“, å­èŠ‚ç‚¹å¯¹åº”å¤šä¸ªä¾èµ–)

## å¼€å‘

è¿™é‡Œæˆ‘ä»¬é¦–å…ˆè§£å†³åœºæ™¯ä¸€å’Œåœºæ™¯äºŒçš„é—®é¢˜, å› ä¸ºåœºæ™¯ä¸‰å·²ç»æœ‰ä¸€ä¸ªå¤§æ¦‚çš„è§£å†³æ–¹æ¡ˆäº†, å…·ä½“çš„é…ç½®æ”¾åˆ°ä¸‹é¢

### æŒ‡ä»¤æŠ€æœ¯é€‰å‹:

1. commander

æ¨èæœ€å¤šçš„, åŒæ—¶ä¹Ÿæ˜¯ä¸‹è½½é‡æœ€å¤šçš„, ä¸‹è½½é‡ 8kw+

2. package-lock.json 

é’ˆå¯¹çš„ lock æ–‡ä»¶, é»˜è®¤ `npm` åŠå…¶å¯¹åº”çš„è§£æ, ç°åœ¨è¿˜æœ‰ `yarn`, `pnpm` æ¯”è¾ƒæµè¡Œ, ä½†æ˜¯
ä¸€èˆ¬åœ¨æœåŠ¡å™¨ä¸Šæ‰“åŒ…æ—¶éƒ½ç”¨ä½¿ç”¨ `npm` æŒ‡ä»¤

3. å¯è§†åŒ–åº“

é’ˆå¯¹æ•°æ®çš„å›¾å½¢åŒ–, è€ƒè™‘äº†ä¸¤æ–¹é¢, æ•°æ®çš„å›¾å½¢åŒ–åº”è¯¥ç”¨ä»€ä¹ˆæ ·çš„æ ¼å¼, å¦ä¸€ä¸ªæ˜¯ä»–çš„æ”¯æŒç¨‹åº¦å’Œæ–¹ä¾¿ç¨‹åº¦

æœ€åæˆ‘å†³å®šæ˜¯ç”¨ echarts æ¥å®ç°, é¦–å…ˆæ˜¯å› ä¸ºå…¬å¸å†…éƒ¨é¡¹ç›®åŸºæœ¬éƒ½æ˜¯æœ‰ echarts çš„ä¾èµ–, å…¶æ¬¡è¿™ä¸ªåº“çš„ä½¿ç”¨äººç¾¤ç‰¹åˆ«å¤š, é€‚é…æ€§æ›´å¥½, å°½é‡é¿å…äº†å¤šä½™çš„ä¾èµ–åº“

### ç¬¬ä¸€æ­¥


1. è·å–é…ç½®æ–‡ä»¶, å¯ä»¥å•ç‹¬æ–‡ä»¶, ä¹Ÿå¯åœ¨ package.json ä¸­, ä¹Ÿå¯é€šè¿‡æŒ‡ä»¤é…ç½®
2. ç¡®è®¤æœ¬åœ°æœ‰æ—  package-lock.json
3. è‹¥æœ‰åˆ™å¯¹å…¶è¿›è¡Œè§£æ, è‹¥æ— åˆ™è¿è¡Œ `npm i` væŒ‡ä»¤, å¾…å…¶ä¸‹è½½å®Œæ¯•åå†è§£æ lock æ–‡ä»¶

æ ¹æ®æˆ‘ä»¬çš„æ€è·¯å…ˆå®ç°ç¬¬ä¸€æ­¥çš„å¼€å‘:

```js
const lockPath = path.resolve('package-lock.json')

async function main() {
    const isExist = fs.existsSync(lockPath)
    // åˆ¤æ–­ lock æ–‡ä»¶, å¦‚æœä¸å­˜åœ¨åˆ™ æ‰§è¡Œ install
    if(!isExist){
        await execNpmInstall()
    }
    // è·å– lock æ–‡ä»¶å†…å®¹
    const data = fs.readFileSync(lockPath, 'utf8')
    // è§£æ json
    console.log(JSON.parse(data))
}

main()
```

### ç¬¬äºŒæ­¥

å…·ä½“çš„è§£ææ–‡ä»¶

æˆ‘ä»¬ä»¥ä¸€ä¸ªç»“æ„æ¥åˆ†æ, å–åä¸ºç»“æ„ A:

```json5
{
  "requires": true,
  "lockfileVersion": 1,
  "dependencies": {
    // çœç•¥
    "react-redux": {
      "version": "7.2.8",
      "resolved": "https://registry.npmmirror.com/react-redux/-/react-redux-7.2.8.tgz",
      "integrity": "sha512-6+uDjhs3PSIclqoCk0kd6iX74gzrGc3W5zcAjbrFgEdIjRSQObdIwfx80unTkVUYvbQ95Y8Av3OvFHq1w5EOUw==",
      "requires": {
        "@babel/runtime": "^7.15.4",
        "@types/react-redux": "^7.1.20",
        "hoist-non-react-statics": "^3.3.2",
        "loose-envify": "^1.4.0",
        "prop-types": "^15.7.2",
        "react-is": "^17.0.2"
      },
      "dependencies": {
        "@babel/runtime": {
          "version": "7.17.9",
          "resolved": "https://registry.npmmirror.com/@babel/runtime/-/runtime-7.17.9.tgz",
          "integrity": "sha512-lSiBBvodq29uShpWGNbgFdKYNiFDo5/HIYsaCEY9ff4sb10x9jizo2+pRrSyF4jKZCXqgzuqBOQKbUm90gQwJg==",
          "requires": {
            "regenerator-runtime": "^0.13.4"
          }
        },
        "react-is": {
          "version": "17.0.2",
          "resolved": "https://registry.npmmirror.com/react-is/-/react-is-17.0.2.tgz",
          "integrity": "sha512-w2GsyukL62IJnlaff/nRegPQR94C/XXamvMWmSHRJ4y7Ts/4ocGRmTHvOs8PSE6pB3dWOrD/nueuU5sduBsQ4w=="
        }
      }
    }
  }
}
```

å…ˆè®²è§£ä¸€ä¸‹ä¸»è¦çš„ key æ˜¯ä»€ä¹ˆæ„æ€:

- lockfileVersion  
  ä¸€ä¸ªæ•´æ•°çš„ç‰ˆæœ¬ï¼Œä»1å¼€å§‹æ˜¯æœ¬æ–‡æ¡£çš„ç‰ˆæœ¬å·ï¼Œåœ¨ç”Ÿæˆè¿™ä¸ªpackage-lock.jsonæ—¶ä½¿ç”¨äº†å…¶è¯­ä¹‰ã€‚
  - æœªæä¾›æ­¤å€¼, è¯´æ˜æ˜¯ npm v5 ç‰ˆæœ¬ä»¥å‰ç”Ÿæˆçš„
  - 1: npm v5å’Œv6ä½¿ç”¨çš„lockfileç‰ˆæœ¬ã€‚
  - 2: npm v7ä½¿ç”¨çš„lockfileç‰ˆæœ¬ï¼Œå‘åå…¼å®¹v1çš„lockfiles
  - 3: npm v7ä½¿ç”¨çš„é”æ–‡ä»¶ç‰ˆæœ¬ï¼Œæ²¡æœ‰å‘åå…¼å®¹çš„èƒ½åŠ›ã€‚è¿™ä¸ªç‰ˆæœ¬å¯èƒ½ä¼šåœ¨æœªæ¥çš„npmä¸­ä½¿ç”¨ã€‚
- dependencies  
  è¿™æ˜¯ä¸€ä¸ªè½¯ä»¶åŒ…åç§°åˆ°ä¾èµ–å¯¹è±¡çš„æ˜ å°„ã€‚
  - integrity
    åœ¨æ­¤ä½ç½®è§£å‹çš„æ–‡ä»¶çš„sha512æˆ–sha1æ ‡å‡†å­èµ„æºå®Œæ•´æ€§å­—ç¬¦ä¸²ã€‚å¯ç”¨äº git æäº¤ã€‚
  - resolved è¿™æ˜¯ç›¸å¯¹äºæ³¨å†Œè¡¨URLçš„å‹ç¼©åŒ…è·¯å¾„ã€‚
  - requires è¿™æ˜¯ä¸€ä¸ªæ¨¡å—åç§°ä¸ç‰ˆæœ¬çš„æ˜ å°„å…³ç³»ã€‚è¿™æ˜¯è¯¥æ¨¡å—éœ€è¦çš„æ‰€æœ‰ä¸œè¥¿çš„åˆ—è¡¨ï¼Œä¸ç®¡å®ƒå°†è¢«å®‰è£…åœ¨å“ªé‡Œã€‚
  - dependencies å’Œä»–çš„çˆ¶å…ƒç´ ä¸€æ ·, ä½†æ˜¯æ˜¯åœ¨å½“å‰åŒ…çš„ node_modules ä¸­ã€‚


åœ¨è¿™ä¸ªä¾èµ–ä¸­çš„ `dependencies` å¯¹åº”çš„åŒ…éƒ½ä¼šå­˜åœ¨äºæ­¤åŒ…çš„ node_modules ä¸­, æ¯”å¦‚:

`react-redux/dependencies/@babel/runtime` è·¯å¾„å°±æ˜¯è¿™æ ·:
`node_modules/react-redux/node_modules/@babel/runtime`


éå†æ‰€æœ‰çš„ä¾èµ–, å¦‚æœä¾èµ–ä¸­è¿˜æœ‰ dependencies åˆ™å°†ä»–æ‹¿å‡ºæ¥å­˜å…¥, å¹¶ä¸”å­˜å…¥å¯¹åº”å…³ç³»
åŒæ—¶å…¶ä»–åº“çš„æ­£å¸¸è”ç³»ä¹Ÿè¦å±•ç°å‡ºæ¥

```js

async function main() {
  const isExist = fs.existsSync(lockPath)
  if(!isExist){
    await execNpmInstall()
  }
  const data = fs.readFileSync(lockPath, 'utf8')
  const contents = JSON.parse(data)
  const allDeps = contents.dependencies
  
  // è¿™é‡Œè·ç¦»å‡ºå¯¹åº”çš„æ ¼å¼
  // æ‰€æœ‰å½“å‰ä¾èµ–ä»¥åŠå¯¹åº”çš„ç‰ˆæœ¬
  const mainPack = new Map() // 'zscroller' => '0.4.8'
  
  // æ‰€æœ‰çš„è¢«ä¾èµ–é¡¹, å¦‚ typedarray-to-buffer ä»“åº“, æ˜¯write-file-atomicçš„ä¾èµ–ä¹‹ä¸€, ä¾èµ–çš„ç‰ˆæœ¬æ˜¯3.1.5, write-file-atomic.requires = typedarray-to-buffer
  const commonPack = new Map() // 'typedarray-to-buffer' => [ { mainPack: 'write-file-atomic', requireVersion: '^3.1.5' } ],
  
  // æ‰€æœ‰åœ¨å­æ¨¡å—ä¸­çš„ä¾èµ–, key æ˜¯ä¸»ä¾èµ–, ä½ç½®: node_modules/whatwg-encoding/node_modules/iconv-lite
  const reDepsPack = new Map() // 'whatwg-encoding' => [ { name: 'iconv-lite', version: '0.4.24' } ],


  const setCommonPack = (requires, name)=>{
    Object.keys(requires).forEach(requireName=>{
      if(!commonPack.has(requireName)){
        commonPack.set(requireName, [])
      }
      const oldVal = commonPack.get(requireName)
      oldVal.push({
        mainPack: name,
        requireVersion: requires[requireName]
      })
      commonPack.set(requireName, oldVal)
    })
  }
  
  Object.keys(allDeps).forEach(name=>{
    const item = allDeps[name]
    if(item.dev){
      return
    }
    mainPack.set(name, item.version)

    if(item.requires){
      setCommonPack(item.requires, name)
    }

    if(item.dependencies){
      const rePacks = Object.keys(item.dependencies).reduce((prev, depsName)=>{
        const depsItem = item.dependencies[depsName]
        prev.push({
          name: depsName,
          version: depsItem.version
        })
        if(depsItem.requires){
          setCommonPack(depsItem.requires, name+'/'+depsName)
        }
        return prev
      }, [])
      reDepsPack.set(name, rePacks) // note, æ˜¯å¦æ·»åŠ  flag
    }
    // ä»¥ reDepsPack çš„ key ä½œä¸º ä¸»è¦å…ƒç´ 
  })

  // ä¸»è¦é€šè¿‡ reDepsPack è½¬æ¢
  // å¯¹ reDepsPack è¿›è¡Œæ•´ç†
  let packs = new Map()
  reDepsPack.forEach((value, key)=>{
    value.forEach(item=>{
      const name = item.name
      if(!packs.has(name)){
        packs.set(name, [])
      }
      const packArr = packs.get(name)
      packArr.push({
        location: `${key}/node_modules/${item.name}`,
        ...item,
        label: 'reDeps'
      })
      packs.set(name, packArr)
    })
  })
}

```

åœ¨è¿™ä¸€æ­¥ æˆ‘å‘ç°ä¹‹å‰çš„æ•°æ®å­˜åœ¨å¾ˆå¤§å†—ä½™, ä¸ºäº†è°ƒå’Œ `reDepsPack` å’Œ `commonPack` çš„ç»“æ„å¯¹äºæ–°å»ºäº† `packs` å¹¶ä¸”è¿›è¡Œäº†å¤šæ¬¡éå†

#### ä¼˜åŒ–

```js
// é‡æ–°è°ƒæ•´éå†ä¾èµ–çš„é€»è¾‘, å¹¶ä¸”æ‰€æœ‰æ•°æ®ç»“æ„åŒæ­¥ä¸ºlocation, version, label
  Object.keys(allDeps).forEach(name => {
    const item = allDeps[name]
    if (item.dev) {
      return
    }
    mainPack.set(name, item.version)

    if (item.requires) {
      setCommonPack(item.requires, name)
    }

    if (item.dependencies) {
      Object.keys(item.dependencies).forEach(depsName => {
        const depsItem = item.dependencies[depsName]
        if (!reDepsPack.has(depsName)) {
          reDepsPack.set(depsName, [])
        }
        const packArr = reDepsPack.get(depsName)
        packArr.push({
          location: `${name}/node_modules/${depsName}`,
          version: depsItem.version,
          label: 'reDeps',
        })
        reDepsPack.set(depsName, packArr)
        if (depsItem.requires) {
          setCommonPack(depsItem.requires, name + '/' + depsName)
        }
      })
    }
  })

// æœ€åå°† reDepsPack å’Œ commonPack åˆå¹¶

const packs = new Map()

reDepsPack.forEach((value, key)=>{
  // console.log(key, commonPack.get(key))
  const itemArr = reDepsPack.get(key)
  if(commonPack.has(key)){
    itemArr.push(...commonPack.get(key))
  }
  packs.set(key, itemArr)
})

```

æœ€åè¾“å‡ºçš„ç»“æœ:

```
  'jsonfile' => [
    {
      location: 'webpack-manifest-plugin/node_modules/jsonfile',
      version: '4.0.0',
      label: 'reDeps'
    },
    { location: 'fs-extra', version: '^6.0.1', label: 'common' },
    {
      location: 'webpack-manifest-plugin/fs-extra',
      version: '^4.0.0',
      label: 'common'
    }
  ],
```

åˆ°è¿™é‡Œå‘ç° `common` å’Œ `reDeps` ä¼šå­˜åœ¨ä¸€ä¸ªé‡å¤çš„ç°è±¡, å› ä¸º lock æ–‡ä»¶ä¸­çš„ç»“æ„æœ¬èº«å°±å­˜åœ¨é‡å¤çš„æƒ…å†µ:

```
    "webpack-manifest-plugin": {
      "version": "2.2.0",
      //...
      "requires": {
        "fs-extra": "^7.0.0",
        //...
      },
      "dependencies": {
        "fs-extra": {
          // ...
        },
        // ...
      }
    }
```

æ‰€ä»¥åœ¨åˆå§‹æ•°æ®è·å–çš„æ—¶å€™, æˆ‘ä»¬éœ€è¦å¯¹å…¶è¿›è¡Œé‡å¤å»é™¤:

```js
if (item.requires) {
  setCommonPack(item.requires, name, item.dependencies)
}

const setCommonPack = (requires, name, deps) => {
  Object.keys(requires).forEach(requireName => {
    if (!commonPack.has(requireName)) {
      commonPack.set(requireName, [])
    }
    // æ·»åŠ é‡å¤çš„åˆ¤æ–­
    if(deps && deps[requireName]){
      return
    }
    const oldVal = commonPack.get(requireName)
    oldVal.push({
      location: name,
      version: requires[requireName],
      label: 'common',
    })
    commonPack.set(requireName, oldVal)
  })
}
```

### ç¬¬ä¸‰æ­¥

é’ˆå¯¹æ•°æ®çš„å›¾å½¢åŒ–, ç›®å‰è®¡åˆ’ä½¿ç”¨çš„å›¾å½¢æ˜¯ echarts ä¸­çš„ npm ä¾èµ–å›¾  
å®˜æ–¹çš„ğŸŒ°: https://echarts.apache.org/examples/zh/editor.html?c=graph-npm

å…¶ä¸­ä»–çš„åœ†å½¢å¤§å°å°ºå¯¸, æˆ‘ä»¬çš„æ•°æ®æºä¸­å¹¶æ²¡æœ‰å‡†å¤‡, æ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨æ•°æ®æºä¸­æ–°å¢ size æ•°æ®



```js

function geFileSize(path) {
  const size = readFile(path, 0) // b
  return (size / 1024).toFixed(2) // å•ä½ kb
}

//éå†è¯»å–æ–‡ä»¶
function readFile(path, size) {
  let files = fs.readdirSync(path)
  files.forEach(walk)

  function walk(file) {
    let states = fs.statSync(path + '/' + file)
    if (states.isDirectory()) {
      readFile(path + '/' + file, size)
    } else {
      size += states.size
    }
  }

  return size
}
```

åŒæ—¶, æˆ‘ä»¬å¯¹äº `common` ä½œå‡ºåˆ¤æ–­, åªå­˜åœ¨ä¸€ä¸ªå°±è¶³å¤Ÿäº†
```js
if(!oldVal.find(it=>it.label === 'common')){
  oldVal.push({
    location: name,
    version: requires[requireName],
    label: 'common',
    size: geFileSize(`./node_modules/${name}`)
  })
  commonPack.set(requireName, oldVal)
}
```

ç”Ÿæˆæ–‡ä»¶åˆ°æ ¹ç›®å½•ä¸‹

ç”±äºç°åœ¨çš„æ•°æ®æ˜¯ `Map` æ ¼å¼, å­˜å‚¨åˆ°å…·ä½“æ–‡ä»¶ä¸­çš„è¯, éœ€è¦ä¸€ç§æ–‡ä»¶æ ¼å¼, è¿™é‡Œæˆ‘å°±å°†ä»–è½¬æ¢æˆ json æ ¼å¼:

```js
```



åŒæ—¶, å¯¹äºå¤šä¸ª common æˆ‘ä»¬éœ€è¦ä½œå‡ºå‹ç¼©, é€‚é…æ­¤æ ¼å¼


### æŒ‡ä»¤çš„å¼€å‘

è®¡åˆ’ä¸­çš„æŒ‡ä»¤

- check
- check deep
- check -open deep

## å‚è€ƒ

- https://docs.npmjs.com/cli/v8/configuring-npm/package-lock-json
